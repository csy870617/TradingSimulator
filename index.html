<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TradingSimulator</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
:root{--b0:#06090f;--b1:#0c1117;--b2:#131a24;--b3:#1a2332;--bd:#1e2d42;--bd2:#2a3f5f;--t1:#e8edf5;--t2:#8899b2;--t3:#4a5d78;--ac:#3b82f6;--acd:rgba(59,130,246,.12);--g:#22c55e;--gd:rgba(34,197,94,.10);--r:#ef4444;--rd:rgba(239,68,68,.10);--y:#eab308;--cy:#06b6d4;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--b0);color:var(--t1);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;overflow-x:hidden;font-size:14px;}
.m{font-family:Menlo,Consolas,'DejaVu Sans Mono',monospace;}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--bd);background:rgba(6,9,15,.92);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;}
.logo{display:flex;align-items:center;gap:9px;font-weight:700;font-size:17px;letter-spacing:-.5px;}
.logo-i{width:30px;height:30px;background:linear-gradient(135deg,var(--ac),var(--cy));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;}
.tabs{display:flex;gap:3px;background:var(--b2);padding:3px;border-radius:9px;}
.tab{padding:7px 18px;border-radius:7px;cursor:pointer;font-size:13px;font-weight:600;color:var(--t2);transition:all .2s;border:none;background:none;font-family:inherit;}
.tab:hover{color:var(--t1);background:var(--b3);}
.tab.on{background:var(--ac);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3);}
main{padding:14px 20px 30px;max-width:1500px;margin:0 auto;}
.sec{display:none;}.sec.on{display:block;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:12px;}
.sc{background:var(--b2);border:1px solid var(--bd);border-radius:9px;padding:11px 14px;}
.sl{font-size:10px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px;}
.sv{font-family:Menlo,Consolas,monospace;font-size:17px;font-weight:700;}
.ss{font-family:Menlo,Consolas,monospace;font-size:11px;margin-top:2px;}
.pos{color:var(--g);}.neg{color:var(--r);}.neu{color:var(--t2);}
.cr{display:flex;align-items:center;gap:7px;margin-bottom:10px;flex-wrap:wrap;}
select,.btn{font-family:inherit;font-size:13px;border:none;outline:none;cursor:pointer;}
select{background:var(--b2);color:var(--t1);padding:8px 11px;border-radius:7px;border:1px solid var(--bd);}
.btn{padding:8px 16px;border-radius:7px;font-weight:600;transition:all .15s;display:flex;align-items:center;gap:5px;}
.bp{background:var(--ac);color:#fff;}.bp:hover{background:#2563eb;}
.bg{background:var(--gd);color:var(--g);border:1px solid rgba(34,197,94,.2);}.bg:hover{background:rgba(34,197,94,.2);}
.br{background:var(--rd);color:var(--r);border:1px solid rgba(239,68,68,.2);}.br:hover{background:rgba(239,68,68,.2);}
.bn{background:linear-gradient(135deg,var(--ac),var(--cy));color:#fff;padding:8px 22px;box-shadow:0 2px 10px rgba(59,130,246,.2);}
.bn:hover{box-shadow:0 4px 18px rgba(59,130,246,.35);transform:translateY(-1px);}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;box-shadow:none!important;}
.sg{display:flex;gap:2px;}
.sb{padding:5px 9px;font-size:11px;font-family:Menlo,Consolas,monospace;background:var(--b2);border:1px solid var(--bd);color:var(--t3);border-radius:5px;cursor:pointer;transition:all .15s;}
.sb.on{color:var(--ac);border-color:var(--ac);background:var(--acd);}
.tf-grp{display:flex;gap:2px;}
.tf-btn{padding:5px 10px;font-size:11px;font-weight:600;background:var(--b2);border:1px solid var(--bd);color:var(--t3);border-radius:5px;cursor:pointer;transition:all .15s;font-family:inherit;}
.tf-btn.on{color:var(--y);border-color:var(--y);background:rgba(234,179,8,.1);}
.cw{background:var(--b2);border:1px solid var(--bd);border-radius:10px;overflow:hidden;margin-bottom:12px;}
.ch{display:flex;align-items:center;justify-content:space-between;padding:9px 14px;border-bottom:1px solid var(--bd);flex-wrap:wrap;gap:6px;}
.sn{font-weight:700;font-size:14px;display:flex;align-items:center;gap:8px;}
.sbg{font-family:Menlo,Consolas,monospace;font-size:10px;background:var(--acd);color:var(--ac);padding:2px 7px;border-radius:4px;font-weight:600;}
.ccw{position:relative;width:100%;height:460px;background:var(--b1);}
.ccw canvas{position:absolute;top:0;left:0;width:100%;height:100%;}
.ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--b1);z-index:5;gap:10px;}
.ov .ic{font-size:36px;opacity:.3;}.ov p{color:var(--t3);font-size:13px;}
.tp{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.tc{background:var(--b2);border:1px solid var(--bd);border-radius:9px;padding:13px 15px;}
.tc h3{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px;}
.ir{display:flex;align-items:center;gap:7px;margin-bottom:7px;}
.ir label{font-size:12px;color:var(--t3);width:48px;flex-shrink:0;}
.ir input{flex:1;background:var(--b1);border:1px solid var(--bd);color:var(--t1);padding:7px 10px;border-radius:5px;font-family:Menlo,Consolas,monospace;font-size:13px;outline:none;}
.ir input:focus{border-color:var(--ac);}
.qb{display:flex;gap:4px;margin-bottom:9px;}
.qb button{flex:1;padding:5px;font-size:11px;font-family:Menlo,Consolas,monospace;background:var(--b1);border:1px solid var(--bd);border-radius:4px;color:var(--t3);cursor:pointer;transition:all .15s;}
.qb button:hover{color:var(--t1);border-color:var(--bd2);}
.lw{max-height:185px;overflow-y:auto;}
.le{font-size:12px;padding:4px 0;border-bottom:1px solid rgba(30,42,69,.3);display:flex;gap:8px;align-items:center;}
.lt{font-family:Menlo,Consolas,monospace;color:var(--t3);font-size:10px;flex-shrink:0;}
.la{font-weight:600;padding:1px 5px;border-radius:3px;font-size:10px;flex-shrink:0;}
.lb{background:var(--gd);color:var(--g);}.ls{background:var(--rd);color:var(--r);}
.pg{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:14px;}
.pc{background:var(--b2);border:1px solid var(--bd);border-radius:10px;overflow:hidden;transition:border-color .2s,transform .2s;}
.pc:hover{border-color:var(--bd2);transform:translateY(-2px);}
.pch{height:200px;background:var(--b1);position:relative;}.pch canvas{width:100%;height:100%;}
.pb{padding:14px;}
.pt{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:2px 7px;border-radius:3px;display:inline-block;margin-bottom:5px;}
.ptb{background:var(--gd);color:var(--g);}.ptr{background:var(--rd);color:var(--r);}.ptn{background:var(--acd);color:var(--ac);}
.pn{font-size:15px;font-weight:700;margin-bottom:5px;letter-spacing:-.3px;}
.pd{font-size:12px;line-height:1.65;color:var(--t2);}
.pp{margin-top:8px;padding:8px 11px;background:var(--b1);border-radius:6px;border-left:3px solid var(--y);font-size:11px;color:var(--t2);line-height:1.55;}
.pp b{color:var(--y);}
.mb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;}
.mb.show{display:flex;}
.mo{background:var(--b2);border:1px solid var(--bd);border-radius:12px;padding:24px;max-width:400px;width:90%;text-align:center;}
.mo h2{font-size:20px;margin-bottom:6px;}.mo p{color:var(--t2);font-size:13px;margin-bottom:4px;line-height:1.5;}
.sr{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bd);font-size:13px;}.sr:last-child{border:none;}
.mo .btn{margin-top:14px;justify-content:center;width:100%;}
.legend{font-size:10px;color:var(--t3);display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.legend span{display:flex;align-items:center;gap:3px;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px;}
@media(max-width:768px){header{padding:8px 12px;flex-wrap:wrap;gap:6px;}main{padding:10px 12px;}.stats{grid-template-columns:repeat(2,1fr);}.tp{grid-template-columns:1fr;}.ccw{height:340px;}.cr{gap:5px;}.btn{padding:7px 12px;font-size:12px;}.pg{grid-template-columns:1fr;}}
</style>
</head>
<body>
<header>
  <div class="logo"><img src="icon.png" alt="logo" style="width:30px;height:30px;border-radius:7px;">TradingSimulator</div>
  <div class="tabs">
    <button class="tab on" data-t="sim">ì‹œë®¬ë ˆì´í„°</button>
    <button class="tab" data-t="pat">íŒ¨í„´ í•™ìŠµ</button>
  </div>
  <div class="m" style="font-size:10px;color:var(--t3)">Space/â†’=ë‹¤ìŒ B=ë§¤ìˆ˜ S=ë§¤ë„</div>
</header>
<main>
  <section class="sec on" id="sec-sim">
    <div class="stats">
      <div class="sc"><div class="sl">ì´ ìì‚° <button id="btn-reset" style="font-size:9px;padding:2px 6px;background:var(--rd);color:var(--r);border:1px solid rgba(239,68,68,.2);border-radius:4px;cursor:pointer;margin-left:6px;font-family:inherit;">ì´ˆê¸°í™”</button></div><div class="sv" id="v-tot">$10,000,000</div><div class="ss neu" id="v-tot-r">0.00%</div></div>
      <div class="sc"><div class="sl">í˜„ê¸ˆ</div><div class="sv" id="v-cash">$10,000,000</div></div>
      <div class="sc"><div class="sl">í‰ê°€ ì†ìµ</div><div class="sv neu" id="v-pnl">â‚©0</div><div class="ss neu" id="v-pnl-r">0.00%</div></div>
      <div class="sc"><div class="sl">ë³´ìœ </div><div class="sv" id="v-qty">0ì£¼</div><div class="ss neu" id="v-avg">í‰ë‹¨ê°€: â€”</div></div>
      <div class="sc"><div class="sl">ê±°ë˜</div><div class="sv" id="v-trd">0</div><div class="ss neu" id="v-wr">ìŠ¹ë¥ : â€”</div></div>
    </div>
    <div class="cr">
      <select id="sel-m"><option value="snp">S&P 500</option><option value="nas">NASDAQ</option><option value="kos">KOSPI</option><option value="kosd">KOSDAQ</option></select>
      <button class="btn bp" id="btn-new">ğŸ² ìƒˆ ì¢…ëª©</button>
      <div class="tf-grp">
        <button class="tf-btn on" data-tf="D">ì¼ë´‰</button>
        <button class="tf-btn" data-tf="W">ì£¼ë´‰</button>
        <button class="tf-btn" data-tf="M">ì›”ë´‰</button>
      </div>
      <div style="flex:1"></div>
      <div class="sg">
        <button class="sb on" data-s="1">1x</button>
        <button class="sb" data-s="5">5x</button>
        <button class="sb" data-s="20">20x</button>
      </div>
      <button class="btn bn" id="btn-nxt" disabled>ë‹¤ìŒ ë´‰ â–¶</button>
      <button class="btn br" id="btn-exit" style="font-size:12px;padding:8px 14px;" disabled>ì¢…ë£Œ</button>
    </div>
    <div class="cw">
      <div class="ch">
        <div class="sn"><span id="s-lbl">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</span><span class="sbg" id="s-tk">â€”</span></div>
        <div style="display:flex;gap:12px;align-items:center;">
          <div class="legend">
            <span><svg width="14" height="2"><line x1="0" y1="1" x2="14" y2="1" stroke="#f59e0b" stroke-width="2"/></svg>MA5</span>
            <span><svg width="14" height="2"><line x1="0" y1="1" x2="14" y2="1" stroke="#8b5cf6" stroke-width="2"/></svg>MA20</span>
            <span><svg width="14" height="2"><line x1="0" y1="1" x2="14" y2="1" stroke="#ec4899" stroke-width="2"/></svg>MA60</span>
            <span><svg width="14" height="2"><line x1="0" y1="1" x2="14" y2="1" stroke="#06b6d4" stroke-width="2"/></svg>MA120</span>
          </div>
          <span class="m" style="font-size:14px;font-weight:700;" id="p-disp">â€”</span>
        </div>
      </div>
      <div class="ccw" id="chart-area">
        <canvas id="cv"></canvas>
        <div class="ov" id="c-ov"><div class="ic">ğŸ“ˆ</div><p>ğŸ² ìƒˆ ì¢…ëª©ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p></div>
      </div>
    </div>
    <div class="tp">
      <div class="tc">
        <h3>ì£¼ë¬¸</h3>
        <div class="ir"><label>ìˆ˜ëŸ‰</label><input type="number" id="i-qty" value="10" min="1"></div>
        <div class="qb"><button data-p="10">10%</button><button data-p="25">25%</button><button data-p="50">50%</button><button data-p="100">ì „ëŸ‰</button></div>
        <div style="display:flex;gap:6px;">
          <button class="btn bg" id="btn-buy" style="flex:1;justify-content:center;" disabled>ë§¤ìˆ˜</button>
          <button class="btn br" id="btn-sell" style="flex:1;justify-content:center;" disabled>ë§¤ë„</button>
        </div>
      </div>
      <div class="tc">
        <h3>ê±°ë˜ ê¸°ë¡</h3>
        <div class="lw" id="log-w"><div style="color:var(--t3);font-size:12px;text-align:center;padding:16px 0;">ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
      </div>
    </div>
  </section>
  <section class="sec" id="sec-pat">
    <div style="margin-bottom:16px;">
      <h2 style="font-size:22px;font-weight:700;margin-bottom:4px;">ì°¨íŠ¸ íŒ¨í„´ í•™ìŠµ (25 Patterns)</h2>
      <p style="color:var(--t2);font-size:13px;">ì‹¤ì „ ë´‰ì°¨íŠ¸ + ì´ë™í‰ê· ì„ ìœ¼ë¡œ í•µì‹¬ íŒ¨í„´ì„ í•™ìŠµí•˜ì„¸ìš”. ì°¨íŠ¸ë¥¼ ë“œë˜ê·¸/ì¤Œí•˜ì—¬ ìì„¸íˆ ì‚´í´ë³´ì„¸ìš”.</p>
    </div>
    <div class="pg" id="p-grid"></div>
  </section>
</main>
<div class="mb" id="modal"><div class="mo"><h2 id="m-t"></h2><p id="m-s"></p><div id="m-st" style="margin:14px 0;"></div><button class="btn bp" onclick="document.getElementById('modal').classList.remove('show')">í™•ì¸</button></div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANDLESTICK CHART ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class CC{
  constructor(cv,o={}){
    this.cv=cv;this.cx=cv.getContext('2d');this.d=[];this.mk=[];this.zones=[];
    this.o={bg:'#0c1117',gc:'rgba(30,45,66,.45)',uc:'#22c55e',dc:'#ef4444',tc:'#4a5d78',
      mac:['#f59e0b','#8b5cf6','#ec4899','#06b6d4'],map:[5,20,60,120],sma:true,svol:true,rp:58,bp:26,tp:12,...o};
    this.sc=0;this.cw=7;this.mnw=1.5;this.mxw=28;this.drag=false;this.lx=0;this.ch=null;
    this._bindEvents();this._rs();
  }
  _bindEvents(){
    const c=this.cv;
    c.addEventListener('wheel',e=>{e.preventDefault();this._zm(e);},{passive:false});
    c.addEventListener('mousedown',e=>{this.drag=true;this.lx=e.clientX;this.ch=null;});
    c.addEventListener('mousemove',e=>{
      if(this.drag){this.sc+=e.clientX-this.lx;this.lx=e.clientX;this._clamp();this.render();}
      else{const r=c.getBoundingClientRect();this.ch={x:(e.clientX-r.left)*this.dpr,y:(e.clientY-r.top)*this.dpr};this.render();}
    });
    c.addEventListener('mouseup',()=>{this.drag=false;});
    c.addEventListener('mouseleave',()=>{this.drag=false;this.ch=null;this.render();});
    this.pinch=false;this.pinchDist=0;
    c.addEventListener('touchstart',e=>{
      if(e.touches.length===2){this.pinch=true;this.drag=false;this.pinchDist=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);this.pinchMidX=((e.touches[0].clientX+e.touches[1].clientX)/2-c.getBoundingClientRect().left)*this.dpr;}
      else if(e.touches.length===1){this.drag=true;this.lx=e.touches[0].clientX;}
    },{passive:true});
    c.addEventListener('touchmove',e=>{
      if(e.touches.length===2&&this.pinch){
        e.preventDefault();
        const nd=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);
        const f=nd/this.pinchDist;const old=this.cw;
        this.cw=Math.max(this.mnw,Math.min(this.mxw,this.cw*f));
        const mx=((e.touches[0].clientX+e.touches[1].clientX)/2-c.getBoundingClientRect().left)*this.dpr;
        this.sc=mx-(mx-this.sc)*(this.cw/old);this._clamp();this.render();
        this.pinchDist=nd;
      }else if(this.drag&&e.touches.length===1){this.sc+=e.touches[0].clientX-this.lx;this.lx=e.touches[0].clientX;this._clamp();this.render();}
    },{passive:false});
    c.addEventListener('touchend',e=>{if(e.touches.length<2)this.pinch=false;if(e.touches.length===0)this.drag=false;});
  }
  _rs(){
    const r=this.cv.parentElement.getBoundingClientRect();const d=window.devicePixelRatio||1;this.dpr=d;
    this.cv.width=r.width*d;this.cv.height=r.height*d;this.cv.style.width=r.width+'px';this.cv.style.height=r.height+'px';
    this.W=r.width*d;this.H=r.height*d;
  }
  _zm(e){
    const old=this.cw;const f=e.deltaY<0?1.12:.89;
    this.cw=Math.max(this.mnw,Math.min(this.mxw,this.cw*f));
    const r=this.cv.getBoundingClientRect();const mx=(e.clientX-r.left)*this.dpr;
    this.sc=mx-(mx-this.sc)*(this.cw/old);this._clamp();this.render();
  }
  _clamp(){
    const tw=this.d.length*this.cw*this.dpr;const cw=this.W-this.o.rp*this.dpr;
    this.sc=Math.max(Math.min(this.sc,cw-this.cw*this.dpr*3),cw-tw);
  }
  setData(d){this.d=d;this.sc=(this.W-this.o.rp*this.dpr)-this.d.length*this.cw*this.dpr;this._clamp();this.render();}
  toEnd(){this.sc=(this.W-this.o.rp*this.dpr)-this.d.length*this.cw*this.dpr;this._clamp();}
  resize(){this._rs();this.render();}
  render(){
    const{cx,W,H,d,o,dpr}=this;const rp=o.rp*dpr,bp=o.bp*dpr,tp=o.tp*dpr;
    const cW=W-rp,cH=H-bp-tp,cw=this.cw*dpr;
    cx.clearRect(0,0,W,H);cx.fillStyle=o.bg;cx.fillRect(0,0,W,H);
    if(!d.length)return;
    const si=Math.max(0,Math.floor(-this.sc/cw)),ei=Math.min(d.length,Math.ceil((cW-this.sc)/cw));
    const vis=d.slice(si,ei);if(!vis.length)return;
    let mn=Infinity,mx=-Infinity;
    for(const v of vis){if(v.low<mn)mn=v.low;if(v.high>mx)mx=v.high;}
    const pad=(mx-mn)*.08||1;mn-=pad;mx+=pad;
    const pY=p=>tp+(1-(p-mn)/(mx-mn))*cH;const iX=i=>this.sc+i*cw;
    // grid
    cx.strokeStyle=o.gc;cx.lineWidth=dpr*.5;
    for(let i=0;i<=6;i++){
      const y=tp+(cH/6)*i;cx.beginPath();cx.moveTo(0,y);cx.lineTo(cW,y);cx.stroke();
      const pr=mx-(mx-mn)*(i/6);cx.fillStyle=o.tc;cx.font=`${9*dpr}px Menlo,Consolas,monospace`;cx.textAlign='left';
      cx.fillText(this._fp(pr),cW+5*dpr,y+3*dpr);
    }
    // dates
    const step=Math.max(1,Math.floor(50/this.cw));
    for(let i=si;i<ei;i+=step){const x=iX(i)+cw/2;if(x<0||x>cW)continue;
      cx.fillStyle=o.tc;cx.font=`${8*dpr}px Menlo,Consolas,monospace`;cx.textAlign='center';
      cx.fillText(d[i].time?d[i].time.slice(2,7):'',x,H-5*dpr);}
    // zones (highlight regions)
    for(const z of this.zones){
      const zs=Math.max(si,z.start),ze=Math.min(ei,z.end);if(zs>=ze)continue;
      const x1=iX(zs),x2=iX(ze)+cw;
      cx.fillStyle=z.color||'rgba(59,130,246,.06)';cx.fillRect(x1,tp,x2-x1,cH);
      cx.strokeStyle=z.border||'rgba(59,130,246,.2)';cx.lineWidth=dpr;cx.setLineDash([4*dpr,3*dpr]);
      cx.beginPath();cx.moveTo(x1,tp);cx.lineTo(x1,tp+cH);cx.stroke();
      cx.beginPath();cx.moveTo(x2,tp);cx.lineTo(x2,tp+cH);cx.stroke();cx.setLineDash([]);
      if(z.label){cx.fillStyle=z.border||'rgba(59,130,246,.5)';cx.font=`${9*dpr}px sans-serif`;cx.textAlign='center';
        cx.fillText(z.label,(x1+x2)/2,tp+12*dpr);}
    }
    // volume
    if(o.svol){const vH=cH*.11,vB=tp+cH;let mV=0;for(const v of vis)if(v.vol>mV)mV=v.vol;
      if(mV>0)for(let i=si;i<ei;i++){const v=d[i],x=iX(i),bw=cw*.7,vh=(v.vol/mV)*vH;
        cx.fillStyle=v.close>=v.open?'rgba(34,197,94,.1)':'rgba(239,68,68,.1)';
        cx.fillRect(x+(cw-bw)/2,vB-vh,bw,vh);}}
    // candles
    for(let i=si;i<ei;i++){const v=d[i],x=iX(i),up=v.close>=v.open,col=up?o.uc:o.dc;
      const bT=pY(Math.max(v.open,v.close)),bB=pY(Math.min(v.open,v.close)),bH=Math.max(bB-bT,dpr);
      const wx=x+cw/2;cx.strokeStyle=col;cx.lineWidth=Math.max(dpr,cw*.08);
      cx.beginPath();cx.moveTo(wx,pY(v.high));cx.lineTo(wx,pY(v.low));cx.stroke();
      cx.fillStyle=col;const bw=cw*.65;cx.fillRect(x+(cw-bw)/2,bT,bw,bH);}
    // MA
    if(o.sma)o.map.forEach((p,mi)=>{if(d.length<p)return;cx.strokeStyle=o.mac[mi];cx.lineWidth=1.3*dpr;cx.beginPath();let st=false;
      for(let i=Math.max(si,p-1);i<ei;i++){let s=0;for(let j=i-p+1;j<=i;j++)s+=d[j].close;
        const ma=s/p,x=iX(i)+cw/2,y=pY(ma);if(x<0||x>cW)continue;
        if(!st){cx.moveTo(x,y);st=true;}else cx.lineTo(x,y);}cx.stroke();});
    // markers
    for(const m of this.mk){if(m.i<si||m.i>=ei)continue;const x=iX(m.i)+cw/2,v=d[m.i],ib=m.t==='buy';
      const y=ib?pY(v.low)+18*dpr:pY(v.high)-18*dpr;
      const sz=10*dpr,hsz=6*dpr;
      // glow
      cx.save();cx.shadowColor=ib?'rgba(34,197,94,.7)':'rgba(239,68,68,.7)';cx.shadowBlur=12*dpr;
      // triangle path
      cx.beginPath();
      if(ib){cx.moveTo(x,y-sz);cx.lineTo(x-hsz,y);cx.lineTo(x+hsz,y);}
      else{cx.moveTo(x,y+sz);cx.lineTo(x-hsz,y);cx.lineTo(x+hsz,y);}
      cx.closePath();cx.fillStyle=ib?o.uc:o.dc;cx.fill();
      // outline
      cx.shadowBlur=0;cx.strokeStyle='#fff';cx.lineWidth=1.5*dpr;cx.stroke();
      cx.restore();
      // label circle
      const ly=ib?y+8*dpr:y-8*dpr;
      cx.beginPath();cx.arc(x,ly,7*dpr,0,Math.PI*2);cx.fillStyle=ib?o.uc:o.dc;cx.fill();
      cx.strokeStyle='#fff';cx.lineWidth=1*dpr;cx.stroke();
      cx.fillStyle='#fff';cx.font=`bold ${8*dpr}px Menlo,Consolas,monospace`;cx.textAlign='center';cx.textBaseline='middle';
      cx.fillText(ib?'B':'S',x,ly);}
    // crosshair
    if(this.ch&&this.ch.x<cW){const{x,y}=this.ch;
      cx.strokeStyle='rgba(59,130,246,.3)';cx.lineWidth=dpr;cx.setLineDash([4*dpr,4*dpr]);
      cx.beginPath();cx.moveTo(x,tp);cx.lineTo(x,tp+cH);cx.stroke();
      cx.beginPath();cx.moveTo(0,y);cx.lineTo(cW,y);cx.stroke();cx.setLineDash([]);
      const hp=mn+(1-(y-tp)/cH)*(mx-mn);cx.fillStyle='#1e3a5f';cx.fillRect(cW,y-9*dpr,rp,18*dpr);
      cx.fillStyle='#e8edf5';cx.font=`${9*dpr}px Menlo,Consolas,monospace`;cx.textAlign='left';cx.fillText(this._fp(hp),cW+4*dpr,y+3*dpr);
      const hi=Math.floor((x-this.sc)/cw);
      if(hi>=0&&hi<d.length){const v=d[hi];const info=`${v.time||''}  O:${this._fp(v.open)} H:${this._fp(v.high)} L:${this._fp(v.low)} C:${this._fp(v.close)}`;
        cx.fillStyle='rgba(12,17,23,.88)';const tw=cx.measureText(info).width+10*dpr;cx.fillRect(5*dpr,tp+2*dpr,tw,16*dpr);
        cx.fillStyle='#e8edf5';cx.font=`${9*dpr}px Menlo,Consolas,monospace`;cx.textAlign='left';cx.fillText(info,10*dpr,tp+13*dpr);}}
    cx.strokeStyle=o.gc;cx.lineWidth=dpr;cx.beginPath();cx.moveTo(cW,0);cx.lineTo(cW,H);cx.stroke();
  }
  _fp(p){return p>=1000?Math.round(p).toLocaleString():p.toFixed(2);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA GENERATION (5 years â‰ˆ 1300 daily candles)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MKT={
  snp:{n:'S&P 500',c:'$',pr:[30,500],s:[
    {t:'AAPL',n:'Apple'},{t:'MSFT',n:'Microsoft'},{t:'GOOGL',n:'Alphabet'},{t:'AMZN',n:'Amazon'},{t:'NVDA',n:'NVIDIA'},
    {t:'META',n:'Meta'},{t:'TSLA',n:'Tesla'},{t:'JPM',n:'JPMorgan'},{t:'V',n:'Visa'},{t:'JNJ',n:'J&J'},
    {t:'WMT',n:'Walmart'},{t:'PG',n:'P&G'},{t:'MA',n:'Mastercard'},{t:'HD',n:'Home Depot'},{t:'CVX',n:'Chevron'},
    {t:'MRK',n:'Merck'},{t:'ABBV',n:'AbbVie'},{t:'PEP',n:'PepsiCo'},{t:'KO',n:'Coca-Cola'},{t:'COST',n:'Costco'},
    {t:'AVGO',n:'Broadcom'},{t:'MCD',n:'McDonalds'},{t:'CSCO',n:'Cisco'},{t:'ACN',n:'Accenture'},{t:'NKE',n:'Nike'},
    {t:'DIS',n:'Disney'},{t:'ADBE',n:'Adobe'},{t:'CRM',n:'Salesforce'},{t:'NFLX',n:'Netflix'},{t:'AMD',n:'AMD'},
    {t:'LLY',n:'Eli Lilly'},{t:'UNH',n:'UnitedHealth'},{t:'BAC',n:'Bank of America'},{t:'XOM',n:'ExxonMobil'},{t:'PFE',n:'Pfizer'},
    {t:'TMO',n:'Thermo Fisher'},{t:'ORCL',n:'Oracle'},{t:'CMCSA',n:'Comcast'},{t:'ABT',n:'Abbott'},{t:'DHR',n:'Danaher'},
    {t:'VZ',n:'Verizon'},{t:'PM',n:'Philip Morris'},{t:'TXN',n:'Texas Instruments'},{t:'NEE',n:'NextEra Energy'},{t:'RTX',n:'RTX'},
    {t:'SPGI',n:'S&P Global'},{t:'HON',n:'Honeywell'},{t:'IBM',n:'IBM'},{t:'AMGN',n:'Amgen'},{t:'LOW',n:'Lowes'},
    {t:'UNP',n:'Union Pacific'},{t:'COP',n:'ConocoPhillips'},{t:'GS',n:'Goldman Sachs'},{t:'ELV',n:'Elevance Health'},{t:'CAT',n:'Caterpillar'},
    {t:'BA',n:'Boeing'},{t:'DE',n:'John Deere'},{t:'BMY',n:'Bristol-Myers'},{t:'LMT',n:'Lockheed Martin'},{t:'SCHW',n:'Schwab'},
    {t:'AXP',n:'American Express'},{t:'MDLZ',n:'Mondelez'},{t:'GILD',n:'Gilead'},{t:'SYK',n:'Stryker'},{t:'BLK',n:'BlackRock'},
    {t:'MMC',n:'Marsh McLennan'},{t:'CB',n:'Chubb'},{t:'ADI',n:'Analog Devices'},{t:'CI',n:'Cigna'},{t:'TJX',n:'TJX'},
    {t:'ADP',n:'ADP'},{t:'TMUS',n:'T-Mobile'},{t:'SBUX',n:'Starbucks'},{t:'MO',n:'Altria'},{t:'SO',n:'Southern Co'},
    {t:'DUK',n:'Duke Energy'},{t:'GE',n:'GE Aerospace'},{t:'BDX',n:'Becton Dickinson'},{t:'PLD',n:'Prologis'},{t:'CL',n:'Colgate'},
    {t:'FDX',n:'FedEx'},{t:'ITW',n:'Illinois Tool Works'},{t:'NOC',n:'Northrop Grumman'},{t:'EOG',n:'EOG Resources'},{t:'SHW',n:'Sherwin-Williams'},
    {t:'MCK',n:'McKesson'},{t:'REGN',n:'Regeneron'},{t:'USB',n:'US Bancorp'},{t:'PNC',n:'PNC Financial'},{t:'APD',n:'Air Products'},
    {t:'CME',n:'CME Group'},{t:'WM',n:'Waste Management'},{t:'TGT',n:'Target'},{t:'ZTS',n:'Zoetis'},{t:'GD',n:'General Dynamics'},
    {t:'ISRG',n:'Intuitive Surgical'},{t:'SLB',n:'SLB'},{t:'CSX',n:'CSX'},{t:'F',n:'Ford'},{t:'GM',n:'General Motors'},
  ]},
  nas:{n:'NASDAQ',c:'$',pr:[20,800],s:[
    {t:'AAPL',n:'Apple'},{t:'MSFT',n:'Microsoft'},{t:'GOOGL',n:'Alphabet'},{t:'AMZN',n:'Amazon'},{t:'NVDA',n:'NVIDIA'},
    {t:'META',n:'Meta'},{t:'TSLA',n:'Tesla'},{t:'NFLX',n:'Netflix'},{t:'ADBE',n:'Adobe'},{t:'CRM',n:'Salesforce'},
    {t:'AMD',n:'AMD'},{t:'INTC',n:'Intel'},{t:'QCOM',n:'Qualcomm'},{t:'PYPL',n:'PayPal'},{t:'BKNG',n:'Booking'},
    {t:'GILD',n:'Gilead'},{t:'ADP',n:'ADP'},{t:'REGN',n:'Regeneron'},{t:'SNPS',n:'Synopsys'},{t:'PANW',n:'Palo Alto'},
    {t:'KLAC',n:'KLA'},{t:'MELI',n:'MercadoLibre'},{t:'LRCX',n:'Lam Research'},{t:'CDNS',n:'Cadence'},{t:'MNST',n:'Monster'},
    {t:'INTU',n:'Intuit'},{t:'ISRG',n:'Intuitive'},{t:'AMAT',n:'Applied Materials'},{t:'VRTX',n:'Vertex'},{t:'MDLZ',n:'Mondelez'},
    {t:'AVGO',n:'Broadcom'},{t:'CSCO',n:'Cisco'},{t:'COST',n:'Costco'},{t:'PEP',n:'PepsiCo'},{t:'TMUS',n:'T-Mobile'},
    {t:'TXN',n:'Texas Instruments'},{t:'CMCSA',n:'Comcast'},{t:'HON',n:'Honeywell'},{t:'AMGN',n:'Amgen'},{t:'SBUX',n:'Starbucks'},
    {t:'ORLY',n:'OReilly Auto'},{t:'FTNT',n:'Fortinet'},{t:'MRVL',n:'Marvell'},{t:'DASH',n:'DoorDash'},{t:'DXCM',n:'DexCom'},
    {t:'TEAM',n:'Atlassian'},{t:'TTD',n:'Trade Desk'},{t:'CRWD',n:'CrowdStrike'},{t:'WDAY',n:'Workday'},{t:'ZS',n:'Zscaler'},
    {t:'ILMN',n:'Illumina'},{t:'IDXX',n:'IDEXX'},{t:'ANSS',n:'ANSYS'},{t:'NXPI',n:'NXP Semi'},{t:'PCAR',n:'PACCAR'},
    {t:'EA',n:'Electronic Arts'},{t:'FAST',n:'Fastenal'},{t:'ROST',n:'Ross Stores'},{t:'VRSK',n:'Verisk'},{t:'CPRT',n:'Copart'},
    {t:'CTSH',n:'Cognizant'},{t:'ODFL',n:'Old Dominion'},{t:'CTAS',n:'Cintas'},{t:'GEHC',n:'GE HealthCare'},{t:'CDW',n:'CDW'},
    {t:'KDP',n:'Keurig Dr Pepper'},{t:'FANG',n:'Diamondback'},{t:'BIIB',n:'Biogen'},{t:'ON',n:'ON Semi'},{t:'MRNA',n:'Moderna'},
    {t:'DDOG',n:'Datadog'},{t:'ABNB',n:'Airbnb'},{t:'COIN',n:'Coinbase'},{t:'ROKU',n:'Roku'},{t:'RIVN',n:'Rivian'},
    {t:'LCID',n:'Lucid'},{t:'PLTR',n:'Palantir'},{t:'SNAP',n:'Snap'},{t:'PINS',n:'Pinterest'},{t:'SQ',n:'Block'},
    {t:'SHOP',n:'Shopify'},{t:'SPOT',n:'Spotify'},{t:'NET',n:'Cloudflare'},{t:'SNOW',n:'Snowflake'},{t:'UBER',n:'Uber'},
    {t:'LYFT',n:'Lyft'},{t:'ZM',n:'Zoom'},{t:'DOCU',n:'DocuSign'},{t:'OKTA',n:'Okta'},{t:'TWLO',n:'Twilio'},
    {t:'ENPH',n:'Enphase'},{t:'SEDG',n:'SolarEdge'},{t:'MCHP',n:'Microchip'},{t:'SWKS',n:'Skyworks'},{t:'WBD',n:'Warner Bros'},
    {t:'PARA',n:'Paramount'},{t:'CHTR',n:'Charter'},{t:'SIRI',n:'SiriusXM'},{t:'LULU',n:'Lululemon'},{t:'MDB',n:'MongoDB'},
  ]},
  kos:{n:'KOSPI',c:'â‚©',pr:[15000,350000],s:[
    {t:'005930',n:'ì‚¼ì„±ì „ì'},{t:'000660',n:'SKí•˜ì´ë‹‰ìŠ¤'},{t:'373220',n:'LGì—ë„ˆì§€ì†”ë£¨ì…˜'},{t:'207940',n:'ì‚¼ì„±ë°”ì´ì˜¤'},{t:'005380',n:'í˜„ëŒ€ì°¨'},
    {t:'006400',n:'ì‚¼ì„±SDI'},{t:'051910',n:'LGí™”í•™'},{t:'035420',n:'NAVER'},{t:'000270',n:'ê¸°ì•„'},{t:'105560',n:'KBê¸ˆìœµ'},
    {t:'055550',n:'ì‹ í•œì§€ì£¼'},{t:'035720',n:'ì¹´ì¹´ì˜¤'},{t:'068270',n:'ì…€íŠ¸ë¦¬ì˜¨'},{t:'003670',n:'í¬ìŠ¤ì½”í™€ë”©ìŠ¤'},{t:'028260',n:'ì‚¼ì„±ë¬¼ì‚°'},
    {t:'012330',n:'í˜„ëŒ€ëª¨ë¹„ìŠ¤'},{t:'066570',n:'LGì „ì'},{t:'034730',n:'SK'},{t:'003550',n:'LG'},{t:'030200',n:'KT'},
    {t:'032830',n:'ì‚¼ì„±ìƒëª…'},{t:'051900',n:'LGìƒí™œê±´ê°•'},{t:'009150',n:'ì‚¼ì„±ì „ê¸°'},{t:'033780',n:'KT&G'},{t:'017670',n:'SKí…”ë ˆì½¤'},
    {t:'018260',n:'ì‚¼ì„±SDS'},{t:'086790',n:'í•˜ë‚˜ê¸ˆìœµ'},{t:'316140',n:'ìš°ë¦¬ê¸ˆìœµ'},{t:'011200',n:'HMM'},{t:'096770',n:'SKì´ë…¸ë² ì´ì…˜'},
    {t:'010130',n:'ê³ ë ¤ì•„ì—°'},{t:'034020',n:'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°'},{t:'009540',n:'í•œêµ­ì¡°ì„ í•´ì–‘'},{t:'011170',n:'ë¡¯ë°ì¼€ë¯¸ì¹¼'},{t:'010950',n:'S-Oil'},
    {t:'000810',n:'ì‚¼ì„±í™”ì¬'},{t:'036570',n:'ì—”ì”¨ì†Œí”„íŠ¸'},{t:'024110',n:'ê¸°ì—…ì€í–‰'},{t:'000100',n:'ìœ í•œì–‘í–‰'},{t:'011790',n:'SKC'},
    {t:'002790',n:'ì•„ëª¨ë ˆí¼ì‹œí”½'},{t:'010140',n:'ì‚¼ì„±ì¤‘ê³µì—…'},{t:'047050',n:'í¬ìŠ¤ì½”ì¸í„°ë‚´ì…”ë„'},{t:'009830',n:'í•œí™”ì†”ë£¨ì…˜'},{t:'004020',n:'í˜„ëŒ€ì œì² '},
    {t:'029780',n:'ì‚¼ì„±ì¹´ë“œ'},{t:'139480',n:'ì´ë§ˆíŠ¸'},{t:'000720',n:'í˜„ëŒ€ê±´ì„¤'},{t:'161390',n:'í•œêµ­íƒ€ì´ì–´'},{t:'267250',n:'HDí˜„ëŒ€'},
    {t:'001570',n:'ê¸ˆì–‘'},{t:'078930',n:'GS'},{t:'090430',n:'ì•„ëª¨ë ˆG'},{t:'021240',n:'ì½”ì›¨ì´'},{t:'004170',n:'ì‹ ì„¸ê³„'},
    {t:'138040',n:'ë©”ë¦¬ì¸ ê¸ˆìœµ'},{t:'006360',n:'GSê±´ì„¤'},{t:'088350',n:'í•œí™”ìƒëª…'},{t:'003490',n:'ëŒ€í•œí•­ê³µ'},{t:'180640',n:'í•œì§„ì¹¼'},
    {t:'005490',n:'POSCOí™€ë”©ìŠ¤'},{t:'323410',n:'ì¹´ì¹´ì˜¤ë±…í¬'},{t:'377300',n:'ì¹´ì¹´ì˜¤í˜ì´'},{t:'259960',n:'í¬ë˜í”„í†¤'},{t:'352820',n:'í•˜ì´ë¸Œ'},
    {t:'047810',n:'í•œêµ­í•­ê³µìš°ì£¼'},{t:'042660',n:'í•œí™”ì˜¤ì…˜'},{t:'272210',n:'í•œí™”ì‹œìŠ¤í…œ'},{t:'012450',n:'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤'},{t:'004990',n:'ë¡¯ë°ì§€ì£¼'},
    {t:'000880',n:'í•œí™”'},{t:'001040',n:'CJ'},{t:'005830',n:'DBì†í•´ë³´í—˜'},{t:'097950',n:'CJì œì¼ì œë‹¹'},{t:'003410',n:'ìŒìš©C&E'},
    {t:'006800',n:'ë¯¸ë˜ì—ì…‹ì¦ê¶Œ'},{t:'016360',n:'ì‚¼ì„±ì¦ê¶Œ'},{t:'069500',n:'KODEX200'},{t:'003240',n:'íƒœê´‘ì‚°ì—…'},{t:'002380',n:'KCC'},
    {t:'041830',n:'ì¸ë°”ë””'},{t:'271560',n:'ì˜¤ë¦¬ì˜¨'},{t:'015760',n:'í•œêµ­ì „ë ¥'},{t:'007070',n:'GSë¦¬í…Œì¼'},{t:'008770',n:'í˜¸í…”ì‹ ë¼'},
    {t:'035250',n:'ê°•ì›ëœë“œ'},{t:'011070',n:'LGì´ë…¸í…'},{t:'030000',n:'ì œì¼ê¸°íš'},{t:'036460',n:'í•œêµ­ê°€ìŠ¤ê³µì‚¬'},{t:'383220',n:'F&F'},
  ]},
  kosd:{n:'KOSDAQ',c:'â‚©',pr:[5000,150000],s:[
    {t:'247540',n:'ì—ì½”í”„ë¡œë¹„ì— '},{t:'086520',n:'ì—ì½”í”„ë¡œ'},{t:'091990',n:'ì…€íŠ¸ë¦¬ì˜¨í—¬ìŠ¤ì¼€ì–´'},{t:'263750',n:'í„ì–´ë¹„ìŠ¤'},{t:'293490',n:'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ'},
    {t:'196170',n:'ì•Œí…Œì˜¤ì  '},{t:'403870',n:'HPSP'},{t:'112040',n:'ìœ„ë©”ì´ë“œ'},{t:'357780',n:'ì†”ë¸Œë ˆì¸'},{t:'145020',n:'íœ´ì ¤'},
    {t:'068760',n:'ì…€íŠ¸ë¦¬ì˜¨ì œì•½'},{t:'041510',n:'ì—ìŠ¤ì— '},{t:'035900',n:'JYP Ent.'},{t:'122870',n:'ì™€ì´ì§€ì—”í„°'},{t:'352820',n:'í•˜ì´ë¸Œ'},
    {t:'328130',n:'ë£¨ë‹›'},{t:'377300',n:'ì¹´ì¹´ì˜¤í˜ì´'},{t:'323410',n:'ì¹´ì¹´ì˜¤ë±…í¬'},{t:'039030',n:'ì´ì˜¤í…Œí¬ë‹‰ìŠ¤'},{t:'058470',n:'ë¦¬ë…¸ê³µì—…'},
    {t:'257720',n:'ì‹¤ë¦¬ì½˜íˆ¬'},{t:'336260',n:'ë‘ì‚°í“¨ì–¼ì…€'},{t:'007210',n:'ë²½ì‚°'},{t:'253450',n:'ìŠ¤íŠœë””ì˜¤ë“œë˜ê³¤'},{t:'235980',n:'ë©”ë“œíŒ©í† '},
    {t:'095340',n:'ISC'},{t:'140860',n:'íŒŒí¬ì‹œìŠ¤í…œìŠ¤'},{t:'108860',n:'ì…€ë°”ìŠ¤AI'},{t:'067630',n:'ì—ì´ì¹˜ì—˜ë¹„'},{t:'141080',n:'ë ˆê³ ì¼ë°”ì´ì˜¤'},
    {t:'214150',n:'í´ë˜ì‹œìŠ¤'},{t:'090460',n:'ë¹„ì—ì´ì¹˜'},{t:'131970',n:'í…ŒìŠ¤ë‚˜'},{t:'278280',n:'ì²œë³´'},{t:'240810',n:'ì›ìµIPS'},
    {t:'036930',n:'ì£¼ì„±ì—”ì§€ë‹ˆì–´ë§'},{t:'089030',n:'í…Œí¬ìœ™'},{t:'033640',n:'ë„¤íŒ¨ìŠ¤'},{t:'067160',n:'ì•„í”„ë¦¬ì¹´TV'},{t:'222080',n:'ì”¨ì•„ì´ì—ìŠ¤'},
    {t:'299030',n:'í•˜ë‚˜ê¸°ìˆ '},{t:'078600',n:'ëŒ€ì£¼ì „ìì¬ë£Œ'},{t:'041920',n:'ë©”ë””ì•„ë‚˜'},{t:'048410',n:'í˜„ëŒ€ë°”ì´ì˜¤'},{t:'060310',n:'3S'},
    {t:'217190',n:'ì œë„ˆì…ˆ'},{t:'950160',n:'ì½”ì˜¤ë¡±í‹°ìŠˆì§„'},{t:'241710',n:'ì½”ìŠ¤ë©”ì¹´ì½”ë¦¬ì•„'},{t:'100120',n:'ë·°ë…¸'},{t:'322510',n:'ì œì´ì—˜ì¼€ì´'},
    {t:'183490',n:'ì—”ì§€ì¸'},{t:'078340',n:'ì»´íˆ¬ìŠ¤'},{t:'025900',n:'ë™í™”ê¸°ì—…'},{t:'046890',n:'ì„œìš¸ë°˜ë„ì²´'},{t:'194480',n:'ë°ë¸Œì‹œìŠ¤í„°ì¦ˆ'},
    {t:'290670',n:'ëŒ€ë³´ë§ˆê·¸ë„¤í‹±'},{t:'064260',n:'ë‹¤ë‚ '},{t:'060280',n:'íë ‰ì†Œ'},{t:'101490',n:'ì—ìŠ¤ì•¤ì—ìŠ¤í…'},{t:'200670',n:'íœ´ë©”ë”•ìŠ¤'},
    {t:'348210',n:'ë„¥ìŠ¤í‹´'},{t:'064290',n:'ì¸í…í”ŒëŸ¬ìŠ¤'},{t:'256840',n:'í•œêµ­ë¹„ì—”ì”¨'},{t:'042000',n:'ì¹´í˜24'},{t:'243070',n:'íœ´ì˜¨ìŠ¤'},
    {t:'086900',n:'ë©”ë””í†¡ìŠ¤'},{t:'039200',n:'ì˜¤ìŠ¤ì½”í…'},{t:'950210',n:'í”„ë ˆìŠ¤í‹°ì§€ë°”ì´ì˜¤'},{t:'115610',n:'ì´ë¯¸ì§€ìŠ¤'},{t:'178320',n:'ì„œì§„ì‹œìŠ¤í…œ'},
    {t:'298380',n:'ì—ì´ë¹„ì—˜ë°”ì´ì˜¤'},{t:'317770',n:'ìŠˆí”„ë¦¬ë§ˆì•„ì´ë””'},{t:'226330',n:'ì‹ í…Œì¹´ë°”ì´ì˜¤'},{t:'114840',n:'ì•„ì´íŒ¨ë°€ë¦¬ì—ìŠ¤ì”¨'},{t:'317830',n:'ì—ìŠ¤í”¼ì‹œìŠ¤í…œìŠ¤'},
    {t:'053800',n:'ì•ˆë©'},{t:'035760',n:'CJ ENM'},{t:'052790',n:'ì•¡í† ì¦ˆì†Œí”„íŠ¸'},{t:'054620',n:'APSí™€ë”©ìŠ¤'},{t:'084370',n:'ìœ ì§„í…Œí¬'},
    {t:'066970',n:'ì—˜ì•¤ì—í”„'},{t:'137400',n:'í”¼ì—”í‹°'},{t:'228760',n:'ì§€ë…¸ë¯¹íŠ¸ë¦¬'},{t:'307950',n:'í˜„ëŒ€ì˜¤í† ì—ë²„'},{t:'347890',n:'ì— íˆ¬ì•„ì´'},
    {t:'205100',n:'ì—‘ì…ˆ'},{t:'352480',n:'ì”¨ì´ë©'},{t:'389030',n:'ì§€ë‹ˆë„ˆìŠ¤'},{t:'376300',n:'ë””ì–´ìœ '},{t:'222160',n:'ë°”ì´ì˜µíŠ¸ë¡œ'},
    {t:'234340',n:'ì œì´ì—ìŠ¤ì½”í¼ë ˆì´ì…˜'},{t:'382480',n:'ì§€ì•„ì´í…'},{t:'419270',n:'ì—ì´ì§ëœë“œ'},{t:'236810',n:'ì—”ë¹„í‹°'},{t:'440110',n:'ì´í“¨ì³'},
    {t:'123410',n:'ì½”ë¦¬ì•„ì—í”„í‹°'},{t:'353810',n:'ì´ì§€ë°”ì´ì˜¤'},{t:'159910',n:'ìŠ¤í‚¨ì•¤ìŠ¤í‚¨'},{t:'204270',n:'ì œì´ì•¤í‹°ì”¨'},{t:'208370',n:'ì…€ë°”ìŠ¤í—¬ìŠ¤ì¼€ì–´'},
  ]}
};

const MAX_DATE=new Date(); // today
const SPLIT_RATIOS=[2,3,4,5,10];
function fmtDt(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return y+'-'+m+'-'+dd;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL DATA FETCHING (Yahoo Finance API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getYahooSymbol(ticker, market){
  if(market==='kos') return ticker+'.KS';
  if(market==='kosd') return ticker+'.KQ';
  return ticker;
}

async function fetchRealData(ticker, market){
  const symbol=getYahooSymbol(ticker, market);
  // Random start year between 2010 and 2023
  const startYear=2010+Math.floor(Math.random()*14);
  const startDate=new Date(startYear, 0, 1);
  const endDate=new Date(); // today
  const period1=Math.floor(startDate.getTime()/1000);
  const period2=Math.floor(endDate.getTime()/1000);
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?period1=${period1}&period2=${period2}&interval=1d`;

  const proxyUrls=[
    url,
    `https://corsproxy.io/?${encodeURIComponent(url)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
  ];

  for(const fetchUrl of proxyUrls){
    try{
      const resp=await fetch(fetchUrl,{signal:AbortSignal.timeout(10000)});
      if(!resp.ok) continue;
      const data=await resp.json();
      const candles=parseYahooData(data, market);
      if(candles&&candles.length>100) return candles;
    }catch(e){continue;}
  }
  return null;
}

function parseYahooData(data, market){
  try{
    const result=data.chart.result[0];
    const ts=result.timestamp;
    const q=result.indicators.quote[0];
    if(!ts||!q.open) return null;
    const isKR=market==='kos'||market==='kosd';
    const r=isKR?0:2;
    const candles=[];
    for(let i=0;i<ts.length;i++){
      if(q.open[i]==null||q.high[i]==null||q.low[i]==null||q.close[i]==null) continue;
      const dt=new Date(ts[i]*1000);
      candles.push({
        time:fmtDt(dt),
        open:+q.open[i].toFixed(r),
        high:+q.high[i].toFixed(r),
        low:+q.low[i].toFixed(r),
        close:+q.close[i].toFixed(r),
        vol:q.volume[i]||0
      });
    }
    return candles;
  }catch(e){return null;}
}

// Fallback: synthetic data generation
function genD(pr,len=1300,startBase,startDt){
  const d=[];let b=startBase||(pr[0]+Math.random()*(pr[1]-pr[0]));
  let dt;
  if(startDt){dt=new Date(startDt);}else{
    const startYear=2010+Math.floor(Math.random()*14);
    dt=new Date(startYear,Math.floor(Math.random()*12),1);
  }
  let tD=Math.random()>.5?1:-1,tL=30+Math.floor(Math.random()*80),tc=0;
  let splitCooldown=200;
  for(let i=0;i<len;i++){
    dt.setDate(dt.getDate()+1);while(dt.getDay()===0||dt.getDay()===6)dt.setDate(dt.getDate()+1);
    if(dt>MAX_DATE)break;
    if(tc++>=tL){tD=Math.random()>.45?1:-1;tL=20+Math.floor(Math.random()*80);tc=0;}
    const v=.008+Math.random()*.025,dr=tD*(.0005+Math.random()*.002),ch=dr+(Math.random()-.5)*v;
    const o=b,c=o*(1+ch),h=Math.max(o,c)*(1+Math.random()*v*.6),l=Math.min(o,c)*(1-Math.random()*v*.6);
    const r=b>1000?0:2;
    const candle={time:fmtDt(dt),open:+o.toFixed(r),high:+h.toFixed(r),low:+l.toFixed(r),close:+c.toFixed(r),vol:Math.floor(3e5+Math.random()*4e6)};
    splitCooldown--;
    if(splitCooldown<=0&&b>pr[1]*1.2&&Math.random()<0.03){
      const ratio=SPLIT_RATIOS[Math.floor(Math.random()*SPLIT_RATIOS.length)];
      candle.split=ratio;
      b=c/ratio;
      candle.close=+(c/ratio).toFixed(r);candle.open=+(o/ratio).toFixed(r);
      candle.high=+(h/ratio).toFixed(r);candle.low=+(l/ratio).toFixed(r);
      splitCooldown=200;
    }
    d.push(candle);
    b=c;if(candle.split)b=candle.close;
    if(b<pr[0]*.3)b=pr[0]*.5;if(b>pr[1]*2)b=pr[1]*1.2;
  }
  return d;
}

function extendData(){
  // With real data, no extension possible beyond what we fetched
  if(S.isRealData) return false;
  const m=MKT[S.mk];const last=S.rawAll[S.rawAll.length-1];
  if(parseDt(last.time)>=MAX_DATE)return false;
  const more=genD(m.pr,500,last.close,last.time);
  if(!more.length)return false;
  S.rawAll=S.rawAll.concat(more);
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMEFRAME AGGREGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDt(s){const p=s.split('-');return new Date(+p[0],+p[1]-1,+p[2]);}
function toWeekly(d){
  const w=[];let cur=null,lastWd=-1;
  for(const c of d){
    const wd=parseDt(c.time).getDay();
    if(!cur||wd<=lastWd){
      if(cur)w.push(cur);cur={time:c.time,open:c.open,high:c.high,low:c.low,close:c.close,vol:c.vol};
    }else{cur.high=Math.max(cur.high,c.high);cur.low=Math.min(cur.low,c.low);cur.close=c.close;cur.vol+=c.vol;}
    lastWd=wd;
  }
  if(cur)w.push(cur);return w;
}

function toMonthly(d){
  const m=[];let cur=null,cm='';
  for(const c of d){
    const ym=c.time.slice(0,7);
    if(ym!==cm){if(cur)m.push(cur);cm=ym;cur={time:c.time,open:c.open,high:c.high,low:c.low,close:c.close,vol:c.vol};}
    else{cur.high=Math.max(cur.high,c.high);cur.low=Math.min(cur.low,c.low);cur.close=c.close;cur.vol+=c.vol;}
  }
  if(cur)m.push(cur);return m;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IC=10000000;
const SAVED_CASH=localStorage.getItem('ts_cash');
let S={mk:'snp',stk:null,rawAll:[],visCntDaily:0,tf:'D',
  cash:SAVED_CASH?parseFloat(SAVED_CASH):IC,pos:{q:0,a:0},trd:0,w:0,l:0,logs:[],spd:1,isRealData:false,stockStartAssets:SAVED_CASH?parseFloat(SAVED_CASH):IC};
let chart=null;

function getVisibleData(){
  const daily=S.rawAll.slice(0,S.visCntDaily);
  if(S.tf==='W')return toWeekly(daily);
  if(S.tf==='M')return toMonthly(daily);
  return daily;
}

function showLoading(show){
  const ov=document.getElementById('c-ov');
  if(show){
    ov.style.display='flex';
    ov.innerHTML='<div class="ic">â³</div><p>ì‹¤ì œ ì£¼ê°€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  }
}

async function startNew(){
  const m=MKT[S.mk];
  // sell any existing position at current price before switching
  if(S.pos.q>0&&S.stk){
    const p=curP();
    S.cash+=p*S.pos.q;
    const pnl=(p-S.pos.a)*S.pos.q;
    if(pnl>0)S.w++;else if(pnl<0)S.l++;
    S.pos={q:0,a:0};
  }
  S.stk=m.s[Math.floor(Math.random()*m.s.length)];

  // Disable buttons during loading
  document.getElementById('btn-new').disabled=true;
  showLoading(true);

  // Try to fetch real historical data
  S.isRealData=false;
  let realData=null;
  try{
    realData=await fetchRealData(S.stk.t, S.mk);
  }catch(e){}

  if(realData&&realData.length>100){
    S.rawAll=realData;
    S.isRealData=true;
  }else{
    // Fallback to synthetic data
    S.rawAll=genD(m.pr,1300);
    S.isRealData=false;
  }

  // start showing 55-65% of data, hide rest as "future"
  S.visCntDaily=Math.floor(S.rawAll.length*.55)+Math.floor(Math.random()*Math.min(100,S.rawAll.length*.1));
  // keep cash (don't reset to IC), only reset on first run
  if(S.cash===0&&S.trd===0)S.cash=IC;
  S.stockStartAssets=S.cash;
  S.logs=[];
  document.getElementById('c-ov').style.display='none';
  document.getElementById('s-lbl').textContent='???';
  document.getElementById('s-tk').textContent='???';
  if(!chart){chart=new CC(document.getElementById('cv'));}else{chart._rs();}
  chart.mk=[];
  renderChart();updateUI();
  document.getElementById('btn-new').disabled=false;
  document.getElementById('btn-nxt').disabled=false;
  document.getElementById('btn-buy').disabled=false;
  document.getElementById('btn-sell').disabled=false;
  document.getElementById('btn-exit').disabled=false;
}

function renderChart(){
  const vis=getVisibleData();
  chart.setData(vis);chart.toEnd();chart.render();
  if(!vis.length)return;
  const last=vis[vis.length-1];const m=MKT[S.mk];
  const ps=m.c==='$'?`$${last.close.toLocaleString('en-US',{minimumFractionDigits:2})}`:`â‚©${Math.round(last.close).toLocaleString()}`;
  const el=document.getElementById('p-disp');el.textContent=ps;
  const prev=vis.length>1?vis[vis.length-2].close:last.open;
  el.style.color=last.close>=prev?'var(--g)':'var(--r)';
}

function advanceOneDaily(){
  // extend data if running out
  if(S.visCntDaily>=S.rawAll.length-10){extendData();}
  if(S.visCntDaily>=S.rawAll.length){showResult(false);return false;}
  S.visCntDaily++;
  const curCandle=S.rawAll[S.visCntDaily-1];
  if(curCandle&&curCandle.split&&S.pos.q>0){
    const ratio=curCandle.split;
    S.pos.q=S.pos.q*ratio;
    S.pos.a=S.pos.a/ratio;
    addLog(`SPLIT 1:${ratio}`,S.pos.q,curCandle.close);
  }
  if(curCandle&&parseDt(curCandle.time)>=MAX_DATE){showResult(false);return false;}
  const p=curP(),tot=S.cash+S.pos.q*p;
  if(tot<=0){showResult(true);return false;}
  return true;
}

function advance(n=1){
  let advanced=false;
  for(let i=0;i<n;i++){
    if(S.tf==='D'){
      if(!advanceOneDaily())break;
      advanced=true;
    }else{
      // For weekly/monthly: advance until a new aggregated candle appears
      const before=getVisibleData().length;
      let ok=true;
      while(ok){
        ok=advanceOneDaily();
        if(ok)advanced=true;
        if(!ok)break;
        if(getVisibleData().length>before)break;
      }
      if(!ok)break;
    }
  }
  if(advanced){renderChart();updateUI();}
}

function curP(){return S.visCntDaily>0&&S.visCntDaily<=S.rawAll.length?S.rawAll[S.visCntDaily-1].close:0;}

function doBuy(){
  const q=parseInt(document.getElementById('i-qty').value)||0;if(q<=0)return;
  const p=curP(),cost=p*q;if(cost>S.cash){alert('ì”ê³  ë¶€ì¡±!');return;}
  S.cash-=cost;const tq=S.pos.q+q;S.pos.a=(S.pos.a*S.pos.q+p*q)/tq;S.pos.q=tq;S.trd++;
  chart.mk.push({i:getVisibleData().length-1,t:'buy'});
  addLog('BUY',q,p);updateUI();chart.render();
}

function doSell(){
  const iq=parseInt(document.getElementById('i-qty').value)||0;
  const q=Math.min(iq,S.pos.q);if(q<=0){alert('ë³´ìœ  ìˆ˜ëŸ‰ ì—†ìŒ!');return;}
  const p=curP();S.cash+=p*q;const pnl=(p-S.pos.a)*q;
  if(pnl>0)S.w++;else if(pnl<0)S.l++;
  S.pos.q-=q;if(S.pos.q===0)S.pos.a=0;S.trd++;
  chart.mk.push({i:getVisibleData().length-1,t:'sell'});
  addLog('SELL',q,p);updateUI();chart.render();
}

function addLog(a,q,p){
  const m=MKT[S.mk];const ps=m.c==='$'?`$${p.toFixed(2)}`:`â‚©${Math.round(p).toLocaleString()}`;
  S.logs.unshift({a,q,p:ps,t:S.rawAll[S.visCntDaily-1].time});renderLogs();
}
function renderLogs(){
  const el=document.getElementById('log-w');
  if(!S.logs.length){el.innerHTML='<div style="color:var(--t3);font-size:12px;text-align:center;padding:16px 0;">ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
  el.innerHTML=S.logs.slice(0,30).map(l=>`<div class="le"><span class="lt">${l.t}</span><span class="la ${l.a==='BUY'?'lb':'ls'}">${l.a==='BUY'?'ë§¤ìˆ˜':'ë§¤ë„'}</span><span style="flex:1;font-family:monospace;font-size:12px;">${l.q}ì£¼ Ã— ${l.p}</span></div>`).join('');
}

function updateUI(){
  const p=curP(),ev=S.pos.q*p,tot=S.cash+ev,tr=(tot-IC)/IC*100;
  const upnl=S.pos.q>0?(p-S.pos.a)*S.pos.q:0,upct=S.pos.a>0?(p-S.pos.a)/S.pos.a*100:0;
  const f=v=>`$${Math.floor(v).toLocaleString()}`;
  document.getElementById('v-tot').textContent=f(tot);
  const tre=document.getElementById('v-tot-r');tre.textContent=`${tr>=0?'+':''}${tr.toFixed(2)}%`;tre.className=`ss ${tr>=0?'pos':'neg'}`;
  document.getElementById('v-cash').textContent=f(S.cash);
  const pe=document.getElementById('v-pnl');pe.textContent=`${upnl>=0?'+':''}${f(upnl)}`;pe.className=`sv ${upnl>=0?'pos':'neg'}`;
  const pre=document.getElementById('v-pnl-r');pre.textContent=`${upct>=0?'+':''}${upct.toFixed(2)}%`;pre.className=`ss ${upct>=0?'pos':'neg'}`;
  document.getElementById('v-qty').textContent=`${S.pos.q}ì£¼`;
  const m=MKT[S.mk];const as=S.pos.a>0?(m.c==='$'?`$${S.pos.a.toFixed(2)}`:`â‚©${Math.round(S.pos.a).toLocaleString()}`):'â€”';
  document.getElementById('v-avg').textContent=`í‰ë‹¨ê°€: ${as}`;
  document.getElementById('v-trd').textContent=S.trd;
  const tt=S.w+S.l;document.getElementById('v-wr').textContent=tt>0?`ìŠ¹ë¥ : ${(S.w/tt*100).toFixed(0)}%`:'ìŠ¹ë¥ : â€”';
  localStorage.setItem('ts_cash',S.cash.toString());
}

function showResult(bankrupt=false){
  if(S.pos.q>0){const p=curP();S.cash+=p*S.pos.q;const pnl=(p-S.pos.a)*S.pos.q;if(pnl>0)S.w++;else if(pnl<0)S.l++;S.pos={q:0,a:0};}
  const stockProfit=S.cash-S.stockStartAssets;
  const stockReturn=S.stockStartAssets>0?(stockProfit/S.stockStartAssets*100):0;
  const ip=stockProfit>=0;
  localStorage.setItem('ts_cash',S.cash.toString());
  document.getElementById('m-t').textContent=bankrupt?'ğŸ’€ íŒŒì‚°!':ip?'ğŸ‰ ìˆ˜ìµ ë‹¬ì„±!':'ğŸ“‰ ì†ì‹¤ ê¸°ë¡';
  document.getElementById('m-s').textContent=`${S.stk.n} (${S.stk.t}) ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼`;
  document.getElementById('s-lbl').textContent=S.stk.n;
  document.getElementById('s-tk').textContent=S.stk.t;
  const tt=S.w+S.l;
  document.getElementById('m-st').innerHTML=`
    <div class="sr"><span>ìˆ˜ìµ</span><span class="m ${ip?'pos':'neg'}">${stockProfit>=0?'+':''}$${Math.floor(Math.abs(stockProfit)).toLocaleString()}${stockProfit<0?' (ì†ì‹¤)':''}</span></div>
    <div class="sr"><span>ìˆ˜ìµë¥ </span><span class="m ${ip?'pos':'neg'}">${stockReturn>=0?'+':''}${stockReturn.toFixed(2)}%</span></div>
    <div class="sr"><span>ì´ ê±°ë˜</span><span class="m">${S.trd}íšŒ</span></div>
    <div class="sr"><span>ìŠ¹ë¥ </span><span class="m">${tt>0?(S.w/tt*100).toFixed(0):'â€”'}%</span></div>
    ${bankrupt?'<div class="sr" style="color:var(--r);font-weight:700;">âš ï¸ ì´ ìì‚°ì´ 0 ì´í•˜ë¡œ íŒŒì‚°í–ˆìŠµë‹ˆë‹¤</div>':''}`;
  document.getElementById('modal').classList.add('show');
  document.getElementById('btn-nxt').disabled=true;
  document.getElementById('btn-buy').disabled=true;
  document.getElementById('btn-sell').disabled=true;
  document.getElementById('btn-exit').disabled=true;
  updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 25 CHART PATTERNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genPat(type,len){
  // Generate pre-context
  const pre=[];let b=100;let dt=new Date(2022,6,1);
  const pushTo=(arr,dir,vol,cnt)=>{for(let i=0;i<cnt;i++){
    dt.setDate(dt.getDate()+1);while(dt.getDay()===0||dt.getDay()===6)dt.setDate(dt.getDate()+1);
    const v=vol*(.6+Math.random()*.8),dr=dir*(.002+Math.random()*.005),ns=(Math.random()-.5)*v;
    const o=b,c=o*(1+dr+ns),h=Math.max(o,c)*(1+Math.random()*v*.4),l=Math.min(o,c)*(1-Math.random()*v*.4);
    arr.push({time:dt.toISOString().split('T')[0],open:+o.toFixed(2),high:+h.toFixed(2),low:+l.toFixed(2),close:+c.toFixed(2),vol:Math.floor(5e5+Math.random()*2e6)});
    b=c;}};
  // pre-context: random walk
  const preDir=Math.random()>.5?1:-1;
  pushTo(pre,preDir,.012,40+Math.floor(Math.random()*20));
  pushTo(pre,-preDir*.5,.008,15+Math.floor(Math.random()*10));

  const patStart=pre.length;
  const d=[...pre];
  const push=(dir,vol,cnt)=>pushTo(d,dir,vol,cnt);

  switch(type){
    case 'double_bottom':push(1,.012,12);push(-1,.018,22);push(1,.01,14);push(-1,.016,20);push(1,.02,25);break;
    case 'double_top':push(-1,.01,8);push(1,.018,22);push(-1,.01,14);push(1,.015,20);push(-1,.022,25);break;
    case 'head_shoulders':push(1,.015,15);push(-1,.01,10);push(1,.02,18);push(-1,.013,12);push(1,.01,12);push(-1,.02,20);break;
    case 'inv_hs':push(-1,.015,15);push(1,.01,10);push(-1,.02,18);push(1,.013,12);push(-1,.01,12);push(1,.02,22);break;
    case 'cup_handle':push(1,.008,8);push(-1,.01,18);push(.2,.007,14);push(1,.012,18);push(-1,.005,8);push(1,.018,18);break;
    case 'asc_tri':for(let i=0;i<5;i++){push(1,.012,9);push(-1,.008-i*.001,7);}push(1,.02,15);break;
    case 'desc_tri':for(let i=0;i<5;i++){push(-1,.012,9);push(1,.008-i*.001,7);}push(-1,.02,15);break;
    case 'bull_flag':push(1,.025,18);push(-.3,.006,15);push(1,.02,20);break;
    case 'bear_flag':push(-1,.025,18);push(.3,.006,15);push(-1,.02,20);break;
    case 'fall_wedge':for(let i=0;i<6;i++){push(-1,.012-i*.001,7);push(1,.008-i*.0005,5);}push(1,.025,18);break;
    case 'rise_wedge':for(let i=0;i<6;i++){push(1,.012-i*.001,7);push(-1,.008-i*.0005,5);}push(-1,.025,18);break;
    case 'sym_tri':for(let i=0;i<6;i++){push(i%2?-1:1,.015-i*.002,8);}push(1,.02,15);break;
    case 'triple_bottom':push(1,.01,10);push(-1,.015,15);push(1,.008,10);push(-1,.014,14);push(1,.007,10);push(-1,.013,13);push(1,.022,22);break;
    case 'triple_top':push(-1,.01,10);push(1,.015,15);push(-1,.008,10);push(1,.014,14);push(-1,.007,10);push(1,.013,13);push(-1,.022,22);break;
    case 'round_bottom':push(-1,.006,15);push(-.3,.004,15);push(.1,.003,15);push(.3,.004,15);push(1,.008,20);break;
    case 'round_top':push(1,.006,15);push(.3,.004,15);push(-.1,.003,15);push(-.3,.004,15);push(-1,.008,20);break;
    case 'bull_pennant':push(1,.028,15);for(let i=0;i<4;i++){push(i%2?1:-1,.006-i*.001,5);}push(1,.022,18);break;
    case 'bear_pennant':push(-1,.028,15);for(let i=0;i<4;i++){push(i%2?-1:1,.006-i*.001,5);}push(-1,.022,18);break;
    case 'island_rev':push(1,.015,20);push(1,.03,3);push(-1,.003,3);push(-1,.03,3);push(-1,.015,20);break;
    case 'gap_up':push(-1,.01,15);push(-.5,.005,8);b*=1.05;push(1,.015,20);push(1,.008,15);break;
    case 'gap_down':push(1,.01,15);push(.5,.005,8);b*=.95;push(-1,.015,20);push(-1,.008,15);break;
    case 'morn_star':push(-1,.015,25);push(-1,.03,1);push(.5,.008,1);push(1,.03,1);push(1,.015,20);break;
    case 'eve_star':push(1,.015,25);push(1,.03,1);push(-.5,.008,1);push(-1,.03,1);push(-1,.015,20);break;
    case 'hammer':push(-1,.015,25);d.push({time:(()=>{dt.setDate(dt.getDate()+1);return dt.toISOString().split('T')[0];})(),open:+b.toFixed(2),high:+(b*1.005).toFixed(2),low:+(b*.97).toFixed(2),close:+(b*1.003).toFixed(2),vol:3e6});b*=1.003;push(1,.015,22);break;
    case 'shoot_star':push(1,.015,25);d.push({time:(()=>{dt.setDate(dt.getDate()+1);return dt.toISOString().split('T')[0];})(),open:+b.toFixed(2),high:+(b*1.03).toFixed(2),low:+(b*.995).toFixed(2),close:+(b*.997).toFixed(2),vol:3e6});b*=.997;push(-1,.015,22);break;
  }
  const patEnd=d.length;
  // post-context: continuation after pattern
  const postDir=Math.random()>.5?1:-1;
  pushTo(d,postDir,.01,30+Math.floor(Math.random()*20));
  pushTo(d,-postDir*.3,.007,15+Math.floor(Math.random()*10));

  return {data:d, patStart, patEnd};
}

const PATS=[
  {id:'double_bottom',n:'ì´ì¤‘ ë°”ë‹¥ (Double Bottom)',tp:'bull',
   d:'ê°€ê²©ì´ ë‘ ë²ˆ ë¹„ìŠ·í•œ ì €ì ì„ í˜•ì„±í•œ í›„ ìƒìŠ¹ ë°˜ì „í•˜ëŠ” Wì íŒ¨í„´. ë‘ ë²ˆì§¸ ì €ì ì—ì„œ ë§¤ìˆ˜ ì‹ í˜¸.',
   tip:'ë‘ ë²ˆì§¸ ë°”ë‹¥ì—ì„œ ê±°ë˜ëŸ‰ì´ ì¤„ê³ , ë„¥ë¼ì¸ ëŒíŒŒ ì‹œ ê±°ë˜ëŸ‰ ì¦ê°€ í™•ì¸.'},
  {id:'double_top',n:'ì´ì¤‘ ì²œì¥ (Double Top)',tp:'bear',
   d:'ë‘ ë²ˆ ë¹„ìŠ·í•œ ê³ ì ì„ í˜•ì„±í•œ í›„ í•˜ë½ ë°˜ì „í•˜ëŠ” Mì íŒ¨í„´. ë‘ ë²ˆì§¸ ê³ ì  ì´í›„ ë§¤ë„ ì‹ í˜¸.',
   tip:'ë‘ ë²ˆì§¸ ê³ ì ì—ì„œ ê±°ë˜ëŸ‰ ê°ì†ŒëŠ” ìƒìŠ¹ í˜ ì•½í™”. ë„¥ë¼ì¸ ì´íƒˆ í›„ ë§¤ë„.'},
  {id:'head_shoulders',n:'í—¤ë“œì•¤ìˆ„ë” (Head & Shoulders)',tp:'bear',
   d:'ì™¼ìª½ ì–´ê¹¨-ë¨¸ë¦¬(ìµœê³ ì )-ì˜¤ë¥¸ìª½ ì–´ê¹¨ì˜ ì„¸ ë´‰ìš°ë¦¬. ìƒìŠ¹ ì¶”ì„¸ ë ëŒ€í‘œì  ë°˜ì „ ì‹ í˜¸.',
   tip:'ë„¥ë¼ì¸ í•˜í–¥ ëŒíŒŒ ì‹œ ë§¤ë„. ë¨¸ë¦¬~ë„¥ë¼ì¸ ê±°ë¦¬ë§Œí¼ í•˜ë½ ê°€ëŠ¥.'},
  {id:'inv_hs',n:'ì—­ í—¤ë“œì•¤ìˆ„ë” (Inverse H&S)',tp:'bull',
   d:'í•˜ë½ ì¶”ì„¸ ë ì„¸ ê³¨ì§œê¸° íŒ¨í„´. ê°€ìš´ë°ê°€ ê°€ì¥ ê¹Šìœ¼ë©° ê°•ë ¥í•œ ìƒìŠ¹ ë°˜ì „ ì‹ í˜¸.',
   tip:'ì˜¤ë¥¸ìª½ ì–´ê¹¨ ê±°ë˜ëŸ‰ > ì™¼ìª½ì´ë©´ ë§¤ìˆ˜ì„¸ ìœ ì… í™•ì¸. ë„¥ë¼ì¸ ëŒíŒŒ í›„ ì§„ì….'},
  {id:'cup_handle',n:'ì»µì•¤í•¸ë“¤ (Cup & Handle)',tp:'bull',
   d:'Uìí˜• ë°”ë‹¥(ì»µ)ê³¼ ì§§ì€ í•˜ë½ ì¡°ì •(í•¸ë“¤). ì¥ê¸° ìƒìŠ¹ ì¶”ì„¸ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” ê°•ë ¥í•œ ë§¤ìˆ˜ ì‹ í˜¸.',
   tip:'ì»µ í˜•ì„± 7~65ì£¼ ì‹œ ìµœê³  ì‹ ë¢°. í•¸ë“¤ì´ ì»µ ê¹Šì´ 1/3 ì´í•˜ë¡œ ì–•ì„ìˆ˜ë¡ ì¢‹ìŒ.'},
  {id:'asc_tri',n:'ìƒìŠ¹ ì‚¼ê°í˜• (Ascending Triangle)',tp:'bull',
   d:'ìˆ˜í‰ ì €í•­ì„  + ìš°ìƒí–¥ ì§€ì§€ì„  ìˆ˜ë ´. ë§¤ìˆ˜ì„¸ ê°•í™” â†’ ìƒë°© ëŒíŒŒ í™•ë¥  ë†’ìŒ.',
   tip:'ì‚¼ê°í˜• 2/3~3/4 ì§€ì  ëŒíŒŒê°€ ê°€ì¥ íš¨ê³¼ì . ëŒíŒŒ ì‹œ ê±°ë˜ëŸ‰ ê¸‰ì¦ í™•ì¸.'},
  {id:'desc_tri',n:'í•˜ë½ ì‚¼ê°í˜• (Descending Triangle)',tp:'bear',
   d:'ìˆ˜í‰ ì§€ì§€ì„  + ìš°í•˜í–¥ ì €í•­ì„  ìˆ˜ë ´. ë§¤ë„ì„¸ ê°•í™” â†’ í•˜ë°© ì´íƒˆ í™•ë¥  ë†’ìŒ.',
   tip:'ì§€ì§€ì„  ì´íƒˆ ì‹œ ê±°ë˜ëŸ‰ ê¸‰ì¦í•˜ë©´ í•˜ë½ ê°€ì†. ì´íƒˆ í›„ ë˜ëŒë¦¼ì—ì„œ ë§¤ë„.'},
  {id:'bull_flag',n:'ìƒìŠ¹ ê¹ƒë°œ (Bull Flag)',tp:'bull',
   d:'ê°•í•œ ìƒìŠ¹(ê¹ƒëŒ€) í›„ ì§§ì€ í•˜í–¥ ì¡°ì •(ê¹ƒë°œ). ì¡°ì • í›„ ë‹¤ì‹œ ìƒìŠ¹ ì¶”ì„¸ ì§€ì†.',
   tip:'ê¹ƒë°œ êµ¬ê°„ ê±°ë˜ëŸ‰ ê°ì†ŒëŠ” ê¸ì •ì  ì‹ í˜¸. ê¹ƒëŒ€ ê¸¸ì´ë§Œí¼ ì¶”ê°€ ìƒìŠ¹ ê¸°ëŒ€.'},
  {id:'bear_flag',n:'í•˜ë½ ê¹ƒë°œ (Bear Flag)',tp:'bear',
   d:'ê°•í•œ í•˜ë½(ê¹ƒëŒ€) í›„ ì§§ì€ ìƒí–¥ ë°˜ë“±(ê¹ƒë°œ). ë°˜ë“± í›„ í•˜ë½ ì¶”ì„¸ ì§€ì†.',
   tip:'ê¹ƒë°œ êµ¬ê°„ì˜ ë°˜ë“±ì´ ì•½í•˜ê³  ê±°ë˜ëŸ‰ì´ ì ì„ìˆ˜ë¡ í•˜ë½ í™•ë¥  ë†’ìŒ.'},
  {id:'fall_wedge',n:'í•˜ë½ ìê¸° (Falling Wedge)',tp:'bull',
   d:'ê³ ì Â·ì €ì  ëª¨ë‘ í•˜ë½í•˜ë˜ ìˆ˜ë ´í•˜ëŠ” íŒ¨í„´. í•˜ë½ì„¸ ì•½í™” â†’ ìƒë°© ëŒíŒŒ ì‹œ ê°•í•œ ìƒìŠ¹.',
   tip:'ìê¸° ë‚´ ê±°ë˜ëŸ‰ ê°ì†Œ â†’ ëŒíŒŒ ì‹œ ì¦ê°€ê°€ ì´ìƒì . ê°€ì§œ í•˜ë°© ì´íƒˆ ì£¼ì˜.'},
  {id:'rise_wedge',n:'ìƒìŠ¹ ìê¸° (Rising Wedge)',tp:'bear',
   d:'ê³ ì Â·ì €ì  ëª¨ë‘ ìƒìŠ¹í•˜ë˜ ìˆ˜ë ´. ìƒìŠ¹ì„¸ ì•½í™”ì˜ ì‹ í˜¸ â†’ í•˜ë°© ì´íƒˆ ì‹œ ê¸‰ë½.',
   tip:'ìƒìŠ¹ ìê¸° ë‚´ ê±°ë˜ëŸ‰ì´ ì ì°¨ ì¤„ë©´ ë§¤ìˆ˜ì„¸ ì†Œì§„ ì‹ í˜¸. ì´íƒˆ í™•ì¸ í›„ ë§¤ë„.'},
  {id:'sym_tri',n:'ëŒ€ì¹­ ì‚¼ê°í˜• (Symmetrical Triangle)',tp:'neu',
   d:'ê³ ì  í•˜ë½ + ì €ì  ìƒìŠ¹ìœ¼ë¡œ ìˆ˜ë ´. ë°©í–¥ì„±ì€ ëŒíŒŒ ë°©í–¥ì— ë”°ë¼ ê²°ì •.',
   tip:'ê¸°ì¡´ ì¶”ì„¸ ë°©í–¥ìœ¼ë¡œ ëŒíŒŒí•  í™•ë¥ ì´ ë†’ìŒ. ì–‘ë°©í–¥ ëª¨ë‘ ëŒ€ë¹„í•˜ë˜ ê¸°ì¡´ ì¶”ì„¸ ë”°ë¼ê°€ê¸°.'},
  {id:'triple_bottom',n:'ì‚¼ì¤‘ ë°”ë‹¥ (Triple Bottom)',tp:'bull',
   d:'ì„¸ ë²ˆ ë¹„ìŠ·í•œ ì €ì  í˜•ì„± í›„ ìƒìŠ¹. ì´ì¤‘ ë°”ë‹¥ë³´ë‹¤ ê°•í•œ ì§€ì§€ í™•ì¸ ì‹ í˜¸.',
   tip:'ì„¸ ë²ˆì§¸ ë°”ë‹¥ì—ì„œ RSI ë‹¤ì´ë²„ì „ìŠ¤ê°€ ë‚˜íƒ€ë‚˜ë©´ ë°˜ì „ ì‹ ë¢°ë„ ê·¹ëŒ€í™”.'},
  {id:'triple_top',n:'ì‚¼ì¤‘ ì²œì¥ (Triple Top)',tp:'bear',
   d:'ì„¸ ë²ˆ ë¹„ìŠ·í•œ ê³ ì  í˜•ì„± í›„ í•˜ë½. ê°•ë ¥í•œ ì €í•­ í™•ì¸ â†’ í•˜ë½ ë°˜ì „ ì‹ í˜¸.',
   tip:'ì„¸ ë²ˆ ì €í•­ ì‹¤íŒ¨ëŠ” ë§¤ìš° ê°•í•œ ë§¤ë„ ì‹ í˜¸. ë„¥ë¼ì¸ ì´íƒˆ ì‹œ í° í•˜ë½ ê¸°ëŒ€.'},
  {id:'round_bottom',n:'ì›í˜• ë°”ë‹¥ (Rounding Bottom)',tp:'bull',
   d:'ì¥ê¸°ê°„ì— ê±¸ì³ Uìí˜•ìœ¼ë¡œ ì„œì„œíˆ ë°”ë‹¥ì„ í˜•ì„±. ì™„ë§Œí•˜ì§€ë§Œ ê°•ë ¥í•œ ìƒìŠ¹ ì „í™˜ ì‹ í˜¸.',
   tip:'í˜•ì„± ê¸°ê°„ì´ ê¸¸ìˆ˜ë¡ ì´í›„ ìƒìŠ¹ í­ì´ í¼. ë„¥ë¼ì¸ ëŒíŒŒ í›„ ì²œì²œíˆ ë§¤ìˆ˜.'},
  {id:'round_top',n:'ì›í˜• ì²œì¥ (Rounding Top)',tp:'bear',
   d:'ì¥ê¸°ê°„ì— ê±¸ì³ ì—­Uìí˜•ìœ¼ë¡œ ì„œì„œíˆ ì²œì¥ì„ í˜•ì„±. ì ì§„ì  í•˜ë½ ì „í™˜ ì‹ í˜¸.',
   tip:'ê±°ë˜ëŸ‰ì´ ê³ ì  í˜•ì„± ê³¼ì •ì—ì„œ ì¤„ì–´ë“¤ë©´ ì²œì¥ í™•ì¸. ì¡°ê¸° ë§¤ë„ë¡œ ìˆ˜ìµ í™•ë³´.'},
  {id:'bull_pennant',n:'ìƒìŠ¹ í˜ë„ŒíŠ¸ (Bull Pennant)',tp:'bull',
   d:'ê°•í•œ ìƒìŠ¹ í›„ ìˆ˜ë ´í˜• ì‚¼ê° ì¡°ì •(í˜ë„ŒíŠ¸). ê¹ƒë°œë³´ë‹¤ ê¸°ê°„ì´ ì§§ê³  ëŒ€ì¹­ ìˆ˜ë ´.',
   tip:'ì¡°ì • ê¸°ê°„ì´ 3ì£¼ ì´ë‚´ì¼ ë•Œ ê°€ì¥ íš¨ê³¼ì . ëŒíŒŒ ì‹œ ê±°ë˜ëŸ‰ ë™ë°˜ í™•ì¸.'},
  {id:'bear_pennant',n:'í•˜ë½ í˜ë„ŒíŠ¸ (Bear Pennant)',tp:'bear',
   d:'ê°•í•œ í•˜ë½ í›„ ìˆ˜ë ´í˜• ì‚¼ê° ë°˜ë“±(í˜ë„ŒíŠ¸). ë°˜ë“± í›„ ë‹¤ì‹œ í•˜ë½ ì§€ì†.',
   tip:'ë°˜ë“± í­ì´ í•˜ë½í­ì˜ 38% ì´ë‚´ì´ë©´ í•˜ë½ ì§€ì† í™•ë¥  ë§¤ìš° ë†’ìŒ.'},
  {id:'island_rev',n:'ì„¬ê¼´ ë°˜ì „ (Island Reversal)',tp:'bear',
   d:'ê°­ ìƒìŠ¹ í›„ ë©°ì¹ ê°„ ê³ ë¦½ëœ ê°€ê²©ëŒ€ í˜•ì„±, ë‹¤ì‹œ ê°­ í•˜ë½. ê°•ë ¥í•œ ë°˜ì „ íŒ¨í„´.',
   tip:'ìƒí•˜ ê°­ì´ ëª¨ë‘ ë©”ì›Œì§€ì§€ ì•Šì„ ë•Œ ê°€ì¥ ê°•ë ¥. ì¶œí˜„ ì¦‰ì‹œ ë°˜ëŒ€ í¬ì§€ì…˜ ê³ ë ¤.'},
  {id:'gap_up',n:'ëŒíŒŒ ê°­ ìƒìŠ¹ (Breakaway Gap Up)',tp:'bull',
   d:'ì¤‘ìš” ì§€ì§€/ì €í•­ì„ ì„ ê°­ìœ¼ë¡œ ëŒíŒŒí•˜ë©° ìƒìŠ¹. ìƒˆë¡œìš´ ì¶”ì„¸ì˜ ì‹œì‘ì„ ì•Œë¦¬ëŠ” ì‹ í˜¸.',
   tip:'ëŒíŒŒ ê°­ì€ ì˜ ë©”ì›Œì§€ì§€ ì•ŠìŒ. ê°­ ë°œìƒ í›„ ë˜ëŒë¦¼ì—ì„œ ë§¤ìˆ˜ ê¸°íšŒ í¬ì°©.'},
  {id:'gap_down',n:'ëŒíŒŒ ê°­ í•˜ë½ (Breakaway Gap Down)',tp:'bear',
   d:'ì¤‘ìš” ì§€ì§€ì„ ì„ ê°­ìœ¼ë¡œ í•˜í–¥ ì´íƒˆ. ê°•ë ¥í•œ ë§¤ë„ì„¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í•˜ë½ ì¶”ì„¸ ì‹œì‘ ì‹ í˜¸.',
   tip:'ê°­ í•˜ë½ í›„ ê°­ì´ ë©”ì›Œì§€ì§€ ì•Šìœ¼ë©´ í•˜ë½ ì¶”ì„¸ ì§€ì†. ë°˜ë“± ì‹œ ë§¤ë„ ê¸°íšŒ.'},
  {id:'morn_star',n:'ëª¨ë‹ìŠ¤íƒ€ (Morning Star)',tp:'bull',
   d:'í•˜ë½ ì¶”ì„¸ì—ì„œ í° ìŒë´‰ â†’ ì‘ì€ ëª¸í†µ(ë³„) â†’ í° ì–‘ë´‰ 3ê°œ ìº”ë“¤ íŒ¨í„´. ìƒìŠ¹ ë°˜ì „.',
   tip:'ë³„ ìº”ë“¤ì´ ê°­ì„ ë™ë°˜í•˜ë©´ ì‹ ë¢°ë„ ìƒìŠ¹. ì„¸ ë²ˆì§¸ ì–‘ë´‰ì´ ì²« ìŒë´‰ì˜ 50% ì´ìƒ íšŒë³µí•´ì•¼ í•¨.'},
  {id:'eve_star',n:'ì´ë¸Œë‹ìŠ¤íƒ€ (Evening Star)',tp:'bear',
   d:'ìƒìŠ¹ ì¶”ì„¸ì—ì„œ í° ì–‘ë´‰ â†’ ì‘ì€ ëª¸í†µ(ë³„) â†’ í° ìŒë´‰ 3ê°œ ìº”ë“¤ íŒ¨í„´. í•˜ë½ ë°˜ì „.',
   tip:'ë³„ ìº”ë“¤ì˜ ê±°ë˜ëŸ‰ì´ ì ê³  ì„¸ ë²ˆì§¸ ìŒë´‰ ê±°ë˜ëŸ‰ì´ í¬ë©´ í•˜ë½ í™•ì‹¤.'},
  {id:'hammer',n:'í•´ë¨¸ (Hammer)',tp:'bull',
   d:'í•˜ë½ ì¶”ì„¸ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” ê¸´ ì•„ë˜ê¼¬ë¦¬ ìº”ë“¤. ì €ê°€ì—ì„œ ë§¤ìˆ˜ì„¸ê°€ ê°•í•˜ê²Œ ìœ ì…ëœ ì‹ í˜¸.',
   tip:'ì•„ë˜ê¼¬ë¦¬ê°€ ëª¸í†µì˜ 2ë°° ì´ìƒì´ë©´ ì‹ ë¢°ë„ ë†’ìŒ. ë‹¤ìŒ ë´‰ í™•ì¸ í›„ ë§¤ìˆ˜.'},
  {id:'shoot_star',n:'ìŠˆíŒ…ìŠ¤íƒ€ (Shooting Star)',tp:'bear',
   d:'ìƒìŠ¹ ì¶”ì„¸ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” ê¸´ ìœ—ê¼¬ë¦¬ ìº”ë“¤. ê³ ê°€ì—ì„œ ë§¤ë„ì„¸ê°€ ìœ ì…ë˜ì–´ ë°€ë ¤ë‚œ ì‹ í˜¸.',
   tip:'ìœ—ê¼¬ë¦¬ê°€ ëª¸í†µì˜ 2ë°° ì´ìƒì´ë©´ ê°•ë ¥í•œ ë§¤ë„ ì‹ í˜¸. ë‹¤ìŒ ë´‰ ìŒë´‰ í™•ì¸ í›„ ë§¤ë„.'},
];

let patCharts=[];

function renderPats(){
  const g=document.getElementById('p-grid');
  g.innerHTML=PATS.map((p,i)=>{
    const tl=p.tp==='bull'?'ìƒìŠ¹':p.tp==='bear'?'í•˜ë½':'ì¤‘ë¦½';
    const tc=p.tp==='bull'?'ptb':p.tp==='bear'?'ptr':'ptn';
    return `<div class="pc"><div class="pch"><canvas id="pc${i}"></canvas></div><div class="pb"><span class="pt ${tc}">${tl}</span><div class="pn">${p.n}</div><div class="pd">${p.d}</div><div class="pp"><b>ğŸ’¡ íŒ:</b> ${p.tip}</div></div></div>`;
  }).join('');
  requestAnimationFrame(()=>{
    patCharts=[];
    PATS.forEach((p,i)=>{
      const cv=document.getElementById(`pc${i}`);if(!cv)return;
      const c=new CC(cv,{bg:'#0c1117',svol:true,sma:true,map:[5,20],mac:['#f59e0b','#8b5cf6'],rp:44,bp:20,tp:8});
      c.mnw=1.5;c.mxw=18;
      const result=genPat(p.id);
      const zoneColor=p.tp==='bull'?'rgba(34,197,94,.06)':p.tp==='bear'?'rgba(239,68,68,.06)':'rgba(59,130,246,.06)';
      const zoneBorder=p.tp==='bull'?'rgba(34,197,94,.25)':p.tp==='bear'?'rgba(239,68,68,.25)':'rgba(59,130,246,.25)';
      c.zones=[{start:result.patStart,end:result.patEnd,color:zoneColor,border:zoneBorder,label:'â—€ íŒ¨í„´ êµ¬ê°„ â–¶'}];
      c.setData(result.data);
      c.cw=Math.max(1.5,Math.min(10,(c.W/(c.dpr||1)-44)/result.data.length));
      // scroll to center the pattern
      const patMid=(result.patStart+result.patEnd)/2;
      const chartW=c.W-44*(c.dpr||1);
      c.sc=chartW/2-patMid*c.cw*(c.dpr||1);
      c._clamp();c.render();patCharts.push(c);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.sec').forEach(x=>x.classList.remove('on'));
  t.classList.add('on');document.getElementById(`sec-${t.dataset.t}`).classList.add('on');
  if(t.dataset.t==='pat')renderPats();
}));
document.getElementById('sel-m').addEventListener('change',e=>{S.mk=e.target.value;});
document.getElementById('btn-new').addEventListener('click',startNew);
document.getElementById('btn-nxt').addEventListener('click',()=>advance(S.spd));
document.getElementById('btn-buy').addEventListener('click',doBuy);
document.getElementById('btn-sell').addEventListener('click',doSell);
document.getElementById('btn-exit').addEventListener('click',()=>{if(S.stk)showResult(false);});
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key===' '||e.key==='ArrowRight'){e.preventDefault();if(!document.getElementById('btn-nxt').disabled)advance(S.spd);}
  if(e.key==='b'||e.key==='B')doBuy();if(e.key==='s'||e.key==='S')doSell();
});
document.querySelectorAll('.qb button').forEach(b=>b.addEventListener('click',()=>{
  const p=curP();if(p<=0)return;const pct=parseInt(b.dataset.p);
  if(S.pos.q>0){
    // if holding shares, calculate sell quantity based on position
    document.getElementById('i-qty').value=Math.max(1,Math.floor(S.pos.q*pct/100));
  }else{
    // otherwise calculate buy quantity based on cash
    document.getElementById('i-qty').value=Math.max(1,Math.floor(S.cash/p*pct/100));
  }
}));
document.querySelectorAll('.sb').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.sb').forEach(x=>x.classList.remove('on'));b.classList.add('on');S.spd=parseInt(b.dataset.s);
}));
// Timeframe buttons
document.querySelectorAll('.tf-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tf-btn').forEach(x=>x.classList.remove('on'));b.classList.add('on');
  S.tf=b.dataset.tf;
  if(chart&&S.rawAll.length){chart.mk=[];renderChart();updateUI();}
}));
// Reset total assets
document.getElementById('btn-reset').addEventListener('click',()=>{
  if(!confirm('ì´ ìì‚°ì„ $10,000,000ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  S.cash=IC;S.pos={q:0,a:0};S.trd=0;S.w=0;S.l=0;S.logs=[];S.stockStartAssets=IC;
  localStorage.setItem('ts_cash',IC.toString());
  updateUI();renderLogs();
});
// Initialize display with saved cash
if(SAVED_CASH){
  const sv=parseFloat(SAVED_CASH);
  document.getElementById('v-tot').textContent=`$${Math.floor(sv).toLocaleString()}`;
  document.getElementById('v-cash').textContent=`$${Math.floor(sv).toLocaleString()}`;
  const tr=(sv-IC)/IC*100;
  const tre=document.getElementById('v-tot-r');tre.textContent=`${tr>=0?'+':''}${tr.toFixed(2)}%`;tre.className=`ss ${tr>=0?'pos':'neg'}`;
}
// Resize
window.addEventListener('resize',()=>{if(chart){chart._rs();chart.render();}});
</script>
</body>
</html>